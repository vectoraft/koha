[% USE raw %]
[% USE Asset %]
[% USE Branches %]
[% USE AuthorisedValues %]
[% USE KohaDates %]
[% USE To %]
[% USE Price %]
[% USE TablesSettings %]
[% PROCESS 'i18n.inc' %]
[% PROCESS 'patron-search.inc' %]
[% SET footerjs = 1 %]
[% INCLUDE 'doc-head-open.inc' %]
<title
    >[% FILTER collapse %]
        [% IF op == 'save' %]
            [% IF ( suggestionid ) %]
                [% tx("Edit suggestion #{suggestion_number}", { suggestion_number = suggestionid }) | html %]
                &rsaquo;
            [% ELSE %]
                [% t("Add suggestion") | html %]
                &rsaquo;
            [% END %]
        [% ELSIF ( op == 'show' ) %]
            [% tx("Show suggestion #{suggestion_number}", { suggestion_number = suggestionid }) | html %]
            &rsaquo;
        [% END %]
        [% t("Suggestions") | html %]
        &rsaquo; [% t("Acquisitions") | html %] &rsaquo; [% t("Koha") | html %]
    [% END %]</title
>
[% INCLUDE 'doc-head-close.inc' %]
[% IF op == 'else' %]
    [% FILTER collapse %]
        <style>
            h4.local_collapse a {
                font-size: 80%;
                text-decoration: none;
            }
            #limits fieldset.brief,
            #limits fieldset.action {
                display: none;
            }
            .overlay {
                background: #eeffd4;
                color: #000;
                display: none;
                left: 50%;
                margin-left: -100px;
                margin-top: -10px;
                padding: 0.5em;
                position: absolute;
                text-align: center;
                top: 180px;
                width: 200px;
            }
        </style>
    [% END %]
[% END %]
</head>

<body id="acq_suggestion" class="acq">
[% WRAPPER 'header.inc' %]
    [% INCLUDE 'cat-search.inc' %]
[% END %]

[% WRAPPER 'sub-header.inc' %]
    [% WRAPPER breadcrumbs %]
        [% WRAPPER breadcrumb_item %]
            <a href="/cgi-bin/koha/acqui/acqui-home.pl">Acquisitions</a>
        [% END %]
        [% IF ( op == 'save' || op == 'show' ) %]
            [% WRAPPER breadcrumb_item %]
                <a href="/cgi-bin/koha/suggestion/suggestion.pl">Suggestions</a>
            [% END %]
        [% END %]
        [% IF op == 'save' %]
            [% IF ( suggestionid ) %]
                [% WRAPPER breadcrumb_item bc_active= 1 %]
                    <span>Edit suggestion #[% suggestionid | html %]</span>
                [% END %]
            [% ELSE %]
                [% WRAPPER breadcrumb_item bc_active= 1 %]
                    <span>Add suggestion</span>
                [% END %]
            [% END %]
        [% ELSIF ( op == 'show' ) %]
            [% WRAPPER breadcrumb_item bc_active= 1 %]
                <span>Show suggestion #[% suggestionid | html %]</span>
            [% END %]
        [% ELSE %]
            [% WRAPPER breadcrumb_item bc_active= 1 %]
                <span>Suggestions management</span>
            [% END %]
        [% END %]
    [% END #/ WRAPPER breadcrumbs %]
[% END #/ WRAPPER sub-header.inc %]

[% IF ( op == 'show' ) %]
    <div class="main container-fluid">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                [% INCLUDE 'messages.inc' %]

                <div id="toolbar" class="btn-toolbar">
                    [% IF CAN_user_suggestions_suggestions_manage %]
                        <a class="btn btn-default" id="editsuggestion" href="suggestion.pl?op=edit_form&amp;suggestionid=[% suggestionid | html %]"><i class="fa-solid fa-pencil" aria-hidden="true"></i> Edit</a>
                    [% END %]
                    [% IF CAN_user_suggestions_suggestions_delete %]
                        <form class="delete_form" method="post" action="/cgi-bin/koha/suggestion/suggestion.pl">
                            [% INCLUDE 'csrf-token.inc' %]
                            <input type="hidden" name="op" value="cud-delete" />
                            <input type="hidden" name="suggestionid" value="[% suggestionid | html %]" />
                            <button type="submit" class="btn btn-default deletesuggestion"><i class="fa fa-trash-can"></i> Delete</button>
                        </form>
                    [% END %]
                </div>

                <fieldset class="rows">
                    <legend>Bibliographic information</legend>
                    <ol>
                        [% IF ( title ) %]
                            <li>
                                <span class="label">Title:</span>
                                [% IF suggestion.biblionumber %]
                                    <a href="/cgi-bin/koha/catalogue/detail.pl?biblionumber=[% suggestion.biblionumber | uri %]">[% suggestion.title | html %]</a>
                                [% ELSE %]
                                    [% title | html %]
                                [% END %]
                            </li>
                        [% END %]
                        [% IF ( author ) %]
                            <li>
                                <span class="label">Author:</span>
                                [% author | html %]
                            </li>
                        [% END %]
                        [% IF ( copyrightdate ) %]
                            <li>
                                <span class="label">Copyright date:</span>
                                [% copyrightdate | html %]
                            </li>
                        [% END %]
                        [% IF ( isbn ) %]
                            <li>
                                <span class="label">ISBN or ISSN or other standard number:</span>
                                [% isbn | html %]
                            </li>
                        [% END %]
                        [% IF ( publishercode ) %]
                            <li>
                                <span class="label">Publisher:</span>
                                [% publishercode | html %]
                            </li>
                        [% END %]
                        [% IF ( place ) %]
                            <li>
                                <span class="label">Publication place:</span>
                                [% place | html %]
                            </li>
                        [% END %]
                        [% IF ( collectiontitle ) %]
                            <li>
                                <span class="label">Collection title:</span>
                                [% collectiontitle | html %]
                            </li>
                        [% END %]
                        [% IF ( itemtype ) %]
                            <li>
                                <span class="label">Document type:</span>
                                [% AuthorisedValues.GetByCode( 'SUGGEST_FORMAT', itemtype, 0 ) | html %]
                            </li>
                        [% END %]
                        [% IF ( patron_reason_loop ) %]
                            <li>
                                <span class="label">Reason for suggestion: </span>
                                [% FOREACH patron_reason_loo IN patron_reason_loop %]
                                    [% IF patron_reason_loo.authorised_value == patronreason %]
                                        [% patron_reason_loo.lib | html %]
                                    [% END %]
                                [% END %]
                            </li>
                        [% END %]
                        [% IF ( note ) %]
                            <li>
                                <span class="label">Notes:</span>
                                [% note | html %]
                            </li>
                        [% END %]
                        [% IF ( staff_note ) %]
                            <li>
                                <span class="label">Notes:</span>
                                [% staff_note | html %]
                            </li>
                        [% END %]
                    </ol>
                </fieldset>

                <fieldset class="rows">
                    <legend>Suggestion management</legend>
                    <ol>
                        <li>
                            <span class="label">Status:</span>
                            [% SET status_found = 0 %]
                            [% IF ( STATUS == 'ASKED' ) %]
                                <span>Pending</span>
                                [% SET status_found = 1 %]
                            [% ELSIF ( STATUS == 'ACCEPTED' ) %]
                                <span>Accepted</span>
                                [% SET status_found = 1 %]
                            [% ELSIF ( STATUS == 'CHECKED' ) %]
                                <span>Checked</span>
                                [% SET status_found = 1 %]
                            [% ELSIF ( STATUS == 'REJECTED' ) %]
                                <span>Rejected</span>
                                [% SET status_found = 1 %]
                            [% ELSIF ( STATUS == 'ORDERED' ) %]
                                <span>Ordered</span>
                                [% SET status_found = 1 %]
                            [% ELSIF ( STATUS == 'AVAILABLE' ) %]
                                <span>Available</span>
                                [% SET status_found = 1 %]
                            [% ELSE %]
                                [% FOREACH s IN SuggestionStatuses %]
                                    [% IF STATUS == s.authorised_value %]
                                        [% s.lib | html %]
                                        [% SET status_found = 1 %]
                                    [% END %]
                                [% END %]
                            [% END %]
                        </li>
                        <li>
                            <span class="label">Reason:</span>
                            [% IF ( reason ) %]
                                [% AuthorisedValues.GetByCode( 'SUGGEST', reason, 0 ) | html %]
                            [% END %]
                        </li>
                    </ol>

                    <table>
                        <thead>
                            <tr>
                                <th>&nbsp;</th>
                                <th>Date</th>
                                <th>By</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>[% tp('purchase suggestion created by', 'Created by:') | html %]</th>
                                <td>[% suggesteddate | $KohaDates %]</td>
                                <td>
                                    [% IF ( suggestedby_patron.borrowernumber ) %]
                                        <a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% suggestedby_patron.borrowernumber | uri %]"
                                            >[% suggestedby_patron.surname | html %], [% suggestedby_patron.firstname | html %] ([% suggestedby_patron.cardnumber | html %])</a
                                        >
                                        [% Branches.GetName( suggestedby_patron.branchcode ) | html %] ([% suggestedby_patron.category.description | html %])
                                    [% END %]
                                </td>
                            </tr>
                            <tr>
                                <th>Managed by:</th>
                                <td>[% manageddate | $KohaDates %]</td>
                                <td>
                                    [% IF ( managedby_patron.borrowernumber ) %]
                                        <a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% managedby_patron.borrowernumber | uri %]"
                                            >[% managedby_patron.surname | html %], [% managedby_patron.firstname | html %] ([% managedby_patron.cardnumber | html %])</a
                                        >
                                        [% Branches.GetName( managedby_patron.branchcode ) | html %] ([% managedby_patron.category.description | html %])
                                    [% END %]
                                </td>
                            </tr>
                            <tr>
                                <th>Accepted on:</th>
                                <td>[% accepteddate | $KohaDates %]</td>
                                <td>
                                    [% IF ( acceptedby_patron.borrowernumber ) %]
                                        <a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% acceptedby_patron.borrowernumber | uri %]"
                                            >[% acceptedby_patron.surname | html %], [% acceptedby_patron.firstname | html %] ([% acceptedby_patron.cardnumber | html %])</a
                                        >
                                        [% Branches.GetName( acceptedby_patron.branchcode ) | html %] ([% acceptedby_patron.category.description | html %])
                                    [% END %]
                                </td>
                            </tr>
                            <tr>
                                <th>Last modification on:</th>
                                <td>[% lastmodificationdate | $KohaDates %]</td>
                                <td>
                                    [% IF ( lastmodificationby_patron.borrowernumber ) %]
                                        <a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% lastmodificationby_patron.borrowernumber | uri %]"
                                            >[% lastmodificationby_patron.surname | html %], [% lastmodificationby_patron.firstname | html %] ([% lastmodificationby_patron.cardnumber | html %])</a
                                        >
                                        [% Branches.GetName( lastmodificationby_patron.branchcode ) | html %] ([% lastmodificationby_patron.category.description | html %])
                                    [% END %]
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </fieldset>

                <fieldset class="rows">
                    <legend>Acquisition information</legend>
                    <ol>
                        <li>
                            <span class="label">Library:</span>
                            [% Branches.GetName( branchcode ) | html %]
                        </li>
                        <li>
                            <span class="label">Fund:</span>
                            [% budgetname | html %]
                        </li>
                        <li>
                            <span class="label">Copies:</span>
                            [% quantity | html %]
                        </li>
                        <li>
                            <span class="label">Currency:</span>
                            [% currency | html %]
                        </li>
                        <li>
                            <span class="label">Price:</span>
                            [% price | $Price %]
                        </li>
                        <li>
                            <span class="label">Total</span>
                            [% total | $Price %]
                        </li>
                    </ol>
                </fieldset>

                <fieldset class="action">
                    <a href="suggestion.pl">&lt;&lt; Back to suggestions</a>
                </fieldset>
            </div>
            <!-- /.col-md-8 offset-md-2 -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.main.container-fluid -->
[% ELSE # IF op == "show" %]

    [% IF op == 'save' %]
        [% SET div_class = "col-md-8 offset-md-2" %]
    [% ELSE %]
        [% SET div_class = "col-md-10 order-md-2 order-sm-1" %]
    [% END %]
    <div class="main container-fluid">
        <div class="row">
            <div class="[% div_class | html %]">
                [% INCLUDE 'messages.inc' %]

                [% IF op == 'save' %]
                    [% FOR m IN messages %]
                        <div class="alert alert-[% m.type | html %]">
                            [% SWITCH m.code %]
                            [% CASE 'biblio_exists' %]
                                <span>A similar document already exists: <a href="/cgi-bin/koha/catalogue/detail.pl?biblionumber=[% m.id | uri %]">[% m.title | html %]</a>. Click on "Confirm your suggestion" to ignore this message.</span>
                            [% CASE 'manager_not_enough_permissions' %]
                                <span>The manager you selected does not have sufficient permissions.</span>
                            [% CASE 'no_manage_permission' %]
                                <span>You do not have permissions to manage suggestions</span>
                            [% CASE 'no_create_permission' %]
                                <span>You do not have permissions to create suggestions</span>
                            [% CASE 'no_delete_permission' %]
                                <span>You do not have permissions to delete suggestions</span>
                            [% CASE %]
                                <span>[% m.code | html %]</span>
                            [% END %]
                        </div>
                        <!-- /.dialog -->
                    [% END %]

                    <form id="add_edit" action="suggestion.pl" method="post" class="validated">
                        [% INCLUDE 'csrf-token.inc' %]
                        <input type="hidden" name="redirect" id="redirect" value="[% redirect | html %]" />
                        <input type="hidden" name="borrowernumber" id="borrowernumber" value="[% borrowernumber | html %]" />
                        [% IF ( suggestionid ) %]
                            <h1>Edit purchase suggestion #[% suggestionid | html %]</h1>
                            <input type="hidden" name="suggestionid" value="[% suggestionid | html %]" />
                        [% ELSE %]
                            <h1>Enter a new purchase suggestion</h1>
                        [% END %]

                        <fieldset class="rows">
                            <legend>Bibliographic information</legend>
                            <ol>
                                <li>
                                    <label for="title" class="required">Title:</label>
                                    <input type="text" id="title" name="title" size="80" maxlength="255" value="[% title | html %]" required="required" class="required" />
                                    <span class="required">Required</span>
                                </li>
                                <li>
                                    <label for="author">Author:</label>
                                    <input type="text" id="author" name="author" size="50" maxlength="80" value="[% author | html %]" />
                                </li>
                                <li>
                                    <label for="copyrightdate">Copyright date:</label>
                                    <input type="text" id="copyrightdate" name="copyrightdate" size="4" maxlength="4" value="[% copyrightdate | html %]" />
                                </li>
                                <li>
                                    <label for="isbn">ISBN or ISSN or other standard number:</label>
                                    <input type="text" id="isbn" name="isbn" size="50" maxlength="80" value="[% isbn | html %]" />
                                </li>
                                <li>
                                    <label for="publishercode">Publisher:</label>
                                    <input type="text" id="publishercode" name="publishercode" size="50" maxlength="80" value="[% publishercode | html %]" />
                                </li>
                                <li>
                                    <label for="place">Publication place:</label>
                                    <input type="text" id="place" name="place" size="50" maxlength="80" value="[% place | html %]" />
                                </li>
                                <li>
                                    <label for="collectiontitle">Collection title:</label>
                                    <input type="text" id="collectiontitle" name="collectiontitle" size="50" maxlength="80" value="[% collectiontitle | html %]" />
                                </li>
                                <li>
                                    <label for="itemtype">Document type:</label>
                                    [% PROCESS 'av-build-dropbox.inc' name="itemtype", category="SUGGEST_FORMAT", size=20, default=itemtype, empty=1 %]
                                </li>
                                [% IF patron_reason_loop %]
                                    <li>
                                        <label for="patronreason">Reason for suggestion: </label>
                                        <select name="patronreason" id="patronreason">
                                            <option value=""> -- Choose -- </option>
                                            [% FOREACH patron_reason_loo IN patron_reason_loop %]
                                                [% IF patron_reason_loo.authorised_value == patronreason %]
                                                    <option value="[% patron_reason_loo.authorised_value | html %]" selected="selected">[% patron_reason_loo.lib | html %]</option>
                                                [% ELSE %]
                                                    <option value="[% patron_reason_loo.authorised_value | html %]">[% patron_reason_loo.lib | html %]</option>
                                                [% END %]
                                            [% END %]
                                        </select>
                                    </li>
                                [% END # /IF patron_reason_loop %]
                                <li>
                                    <label for="note">Notes:</label>
                                    <textarea name="note" id="note" rows="5" cols="40">[% note | html %]</textarea>
                                </li>
                                <li>
                                    <label for="note">Non-public notes:</label>
                                    <textarea name="staff_note" id="staff_note" rows="5" cols="40">[% staff_note | html %]</textarea>
                                </li>
                            </ol>
                        </fieldset>

                        <fieldset class="rows">
                            <legend>Suggestion management</legend>
                            <ol>
                                [% IF ( suggestionid ) %]
                                    <li>
                                        <label for="STATUS">Status:</label>
                                        <select id="STATUS" name="STATUS">
                                            <option value="">No status</option>

                                            [% IF (statusselected_ASKED ) %]
                                                <option value="ASKED" selected="selected">Pending</option>
                                            [% ELSE %]
                                                <option value="ASKED">Pending</option>
                                            [% END %]

                                            [% IF (statusselected_ACCEPTED ) %]
                                                <option value="ACCEPTED" selected="selected">Accepted</option>
                                            [% ELSE %]
                                                <option value="ACCEPTED">Accepted</option>
                                            [% END %]

                                            [% IF (statusselected_CHECKED ) %]
                                                <option value="CHECKED" selected="selected">Checked</option>
                                            [% ELSE %]
                                                <option value="CHECKED">Checked</option>
                                            [% END %]

                                            [% IF ( statusselected_REJECTED ) %]
                                                <option value="REJECTED" selected="selected">Rejected</option>
                                            [% ELSE %]
                                                <option value="REJECTED">Rejected</option>
                                            [% END %]

                                            [% IF ( statusselected_ORDERED ) %]
                                                <option value="ORDERED" selected="selected">Ordered</option>
                                            [% ELSE %]
                                                <option value="ORDERED">Ordered</option>
                                            [% END %]

                                            [% IF ( statusselected_AVAILABLE ) %]
                                                <option value="AVAILABLE" selected="selected">Available</option>
                                            [% ELSE %]
                                                <option value="AVAILABLE">Available</option>
                                            [% END %]

                                            [% FOREACH s IN SuggestionStatuses %]
                                                [% IF s.authorised_value == suggestion.STATUS %]
                                                    <option value="[% s.authorised_value | html %]" selected="selected">[% s.lib | html %]</option>
                                                [% ELSE %]
                                                    <option value="[% s.authorised_value | html %]">[% s.lib | html %]</option>
                                                [% END %]
                                            [% END %]
                                        </select>
                                    </li>
                                    <li>
                                        <label for="reason">Reason:</label>
                                        <select class="select-reason" id="reason" name="reason">
                                            <option value=""> -- Choose a reason -- </option>
                                            [% FOREACH reasonsloo IN suggestion.reasonsloop %]
                                                [% IF (reasonsloo.lib == suggestion.reason) %]
                                                    <option value="[% reasonsloo.lib | html %]" selected="selected">[% reasonsloo.lib | html %]</option>
                                                [% ELSE %]
                                                    <option value="[% reasonsloo.lib | html %]">[% reasonsloo.lib | html %]</option>
                                                [% END %]
                                            [% END %]
                                            <option value="other">Others...</option>
                                        </select>

                                        <span id="other_reason" name="other_reason">
                                            [% IF other_reason %]
                                                <input type="text" size="31" id="select-other_reason" name="other_reason" placeholder="please note your reason here..." value="[% suggestion.reason | html %]" />
                                            [% ELSE %]
                                                <input type="text" size="31" id="select-other_reason" name="other_reason" placeholder="please note your reason here..." />
                                            [% END %]
                                            <a href="#back">Cancel</a>
                                        </span>
                                    </li>
                                [% END %]
                                <li>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>&nbsp;</th>
                                                <th>Date</th>
                                                <th>By</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <th>
                                                    <label for="suggesteddate">[% tp('purchase suggestion created by', 'Created by:') | html %]</label>
                                                </th>
                                                <td> <input type="text" id="suggesteddate" name="suggesteddate" class="flatpickr" size="10" maxlength="10" value="[% suggesteddate | html %]" /> [% INCLUDE 'date-format.inc' %] </td>
                                                <td id="tdsuggestedby">
                                                    <input type="hidden" id="suggestedby" name="suggestedby" value="[% suggestedby | html %]" />
                                                    [% IF ( suggestedby_patron.borrowernumber ) %]
                                                        <a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% suggestedby_patron.borrowernumber | uri %]"
                                                            >[% suggestedby_patron.surname | html %], [% suggestedby_patron.firstname | html %] ([% suggestedby_patron.cardnumber | html %])</a
                                                        >
                                                        [% Branches.GetName( suggestedby_patron.branchcode ) | html %] ([% suggestedby_patron.category.description | html %])
                                                    [% END %]
                                                </td>
                                                <td>
                                                    <a href="#patron_search_modal_suggester" id="edit_suggester" class="btn btn-default" data-bs-toggle="modal">Set to patron</a>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>
                                                    <label for="accepteddate">Accepted on:</label>
                                                </th>
                                                <td> <input type="text" id="accepteddate" name="accepteddate" class="flatpickr" size="10" maxlength="10" value="[% accepteddate | html %]" />[% INCLUDE 'date-format.inc' %] </td>
                                                <td>
                                                    <input type="hidden" id="acceptedby" name="acceptedby" value="[% acceptedby | html %]" />
                                                    [% IF ( acceptedby_patron.borrowernumber ) %]
                                                        <a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% acceptedby_patron.borrowernumber | uri %]"
                                                            >[% acceptedby_patron.surname | html %], [% acceptedby_patron.firstname | html %] ([% acceptedby_patron.cardnumber | html %])</a
                                                        >
                                                        [% Branches.GetName( acceptedby_patron.branchcode ) | html %] ([% acceptedby_patron.category.description | html %])
                                                    [% END %]
                                                </td>
                                                <td></td>
                                            </tr>
                                            <tr>
                                                <th>
                                                    <label for="lastmodificationdate">Last modification on:</label>
                                                </th>
                                                <td> [% lastmodificationdate | $KohaDates %] </td>
                                                <td>
                                                    [% IF lastmodificationby_patron %]
                                                        [% INCLUDE 'patron-title.inc' patron=lastmodificationby_patron hide_patron_infos_if_needed=1 %]
                                                        [% Branches.GetName( lastmodificationby_patron.branchcode ) | html %]
                                                        ([% lastmodificationby_patron.category.description | html %])
                                                    [% END %]
                                                </td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </li>
                                <li>
                                    <label for="managedon">Managed on:</label>
                                    <input type="text" id="managedon" name="manageddate" class="flatpickr" size="10" maxlength="10" value="[% manageddate | html %]" />[% INCLUDE 'date-format.inc' %]
                                </li>
                                <li>
                                    <label for="managedby_name">by:</label>
                                    <div>
                                        <span id="managedby_name" name="managedby_name">
                                            [% IF CAN_user_suggestions_suggestions_manage %]
                                                <a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% logged_in_user.borrowernumber | uri %]">You</a>
                                            [% ELSE %]
                                                Nobody
                                            [% END %]
                                        </span>
                                        [% IF managedby_patron.borrowernumber && logged_in_user.borrowernumber != managedby_patron.borrowernumber %]
                                            | Previously was [% INCLUDE 'patron-title.inc' patron=managedby_patron hide_patron_infos_if_needed=1 %] [% Branches.GetName( managedby_patron.branchcode ) | html %]
                                            ([% managedby_patron.category.description | html %])
                                        [% END %]
                                        <br />
                                        <a href="#patron_search_modal_manager" id="edit_manager" data-bs-toggle="modal"><i class="fa fa-search"></i> Select manager</a>
                                        [% IF managedby_patron.borrowernumber && logged_in_user.borrowernumber != managedby_patron.borrowernumber %]
                                            <a id="restore_previous_manager" href="#"><i class="fa fa-trash-can"></i> Keep existing manager</a>
                                        [% END %]
                                        [% IF CAN_user_suggestions_suggestions_manage %]
                                            <input type="hidden" name="managedby" id="managedby" value="[% logged_in_user.borrowernumber | html %]" />
                                        [% END %]

                                        <br />
                                        <label for="notify">Notify manager:</label>
                                        <input
                                            type="checkbox"
                                            id="notify"
                                            name="notify"
                                            value="notify"
                                            disabled="disabled"
                                            title="A NOTIFY_MANAGER notice will be generated and send to the manager if a valid email address is defined. This can be checked if a new manager has been selected."
                                        />
                                    </div>
                                    <!-- /div -->
                                </li>
                            </ol>
                        </fieldset>

                        <fieldset class="rows">
                            <legend>Acquisition information</legend>
                            <ol>
                                <li>
                                    <label for="branchcode">Library:</label>
                                    <select name="branchcode" id="branchcode">
                                        <option value="">Any</option>
                                        [% PROCESS options_for_libraries libraries => Branches.all( selected => branchcode ) %]
                                    </select>
                                </li>
                                <li> [% PROCESS funds_dropdown %] </li>
                                <li>
                                    <label for="quantity">Copies:</label>
                                    <input type="text" size="10" id="quantity" name="quantity" value="[% quantity | html %]" />
                                </li>
                                <li>
                                    <label for="currency">Currency:</label>
                                    [% FOREACH c IN currencies %]
                                        <input type="hidden" value="[% c.rate | html %]" id="currency_rate_[% c.currency | html %]" name="currency_rate_[% c.currency | html %]" />
                                        <input type="hidden" id="[% c.currency | html %]" name="[% c.currency | html %]" value="[% c.rate | html %]" />
                                    [% END %]
                                    <select name="currency" id="currency">
                                        [% FOREACH c IN currencies %]
                                            [% IF suggestionid and suggestion.currency == c.currency or not suggestionid and c.active %]
                                                <option value="[% c.currency | html %]" selected="selected">[% c.currency | html %]</option>
                                            [% ELSIF not c.archived %]
                                                <option value="[% c.currency | html %]">[% c.currency | html %]</option>
                                            [% END %]
                                        [% END %]
                                    </select>
                                </li>
                                <li>
                                    <label for="price">Price:</label>
                                    <input class="decimal" type="text" size="20" name="price" id="price" value="[% price | $Price on_editing => 1 %]" />
                                </li>
                                <li>
                                    <label for="total">Total: </label>
                                    <input type="text" readonly="readonly" id="total" name="total" size="10" value="[% total | html %]" />
                                </li>
                            </ol>
                        </fieldset>
                        <!-- /.rows -->

                        <fieldset class="action">
                            <input type="hidden" id="returnsuggested" name="returnsuggested" value="[% IF ( returnsuggestedby ) %][% returnsuggestedby | html %][% ELSE %]no_one[% END %]" />
                            [% IF ( suggestionid ) %]
                                <input type="hidden" name="op" value="cud-save" />
                                [% IF ( need_confirm ) %]
                                    <input type="hidden" name="save_confirmed" value="1" />
                                    <input type="submit" class="btn btn-primary" value="Confirm your suggestion" />
                                [% ELSE %]
                                    <input type="submit" class="btn btn-primary" value="Save" />
                                [% END %]
                                <a class="cancel" href="[% IF ( returnsuggestedby ) %]/cgi-bin/koha/members/moremember.pl?borrowernumber=[% returnsuggestedby | uri %]#suggestions[% ELSE %]suggestion.pl[% END %]">Cancel</a>
                            [% ELSE %]
                                <input type="hidden" name="op" value="cud-save" />
                                [% IF ( need_confirm ) %]
                                    <input type="hidden" name="save_confirmed" value="1" />
                                    <input type="submit" class="btn btn-primary" value="Confirm your suggestion" />
                                [% ELSE %]
                                    <input type="submit" class="btn btn-primary" value="Submit your suggestion" />
                                [% END %]
                                <a class="cancel" href="suggestion.pl">Cancel</a>
                            [% END %]
                        </fieldset>
                        <!-- /.action -->
                    </form>
                    <!-- /#add_edit -->
                [% END %]

                [% IF op == 'else' %]
                    <div id="toolbar" class="btn-toolbar">
                        [% IF CAN_user_suggestions_suggestions_create %]
                            <a class="btn btn-default" id="newsuggestion" href="suggestion.pl?op=add_form&branchcode=[% branchcode | uri %]"><i class="fa fa-plus"></i> New purchase suggestion</a>
                        [% END %]
                    </div>

                    <h1>Suggestions management</h1>

                    [% IF ( displayby != "branchcode" ) %]
                        <label for="branchcode">Viewing suggestions for library:</label>
                        <select name="branchcode" id="branchcode">
                            <option value="__ANY__">Any</option>
                            [% PROCESS options_for_libraries libraries => Branches.all( selected => branchfilter || branchcode ) %]
                        </select>
                    [% END %]

                    [% FOR m IN messages %]
                        <div class="alert alert-[% m.type | html %]">
                            [% SWITCH m.code %]
                            [% CASE 'already_exists' %]
                                <span
                                    >The suggestion has not been added. A suggestion with this title already exists (<a href="/cgi-bin/koha/suggestion/suggestion.pl?suggestionid=[% m.id | uri %]&op=show">suggestion #[% m.id | html %]</a
                                    >)</span
                                >
                            [% CASE 'biblio_exists' %]
                                <span>A similar document already exists: <a href="/cgi-bin/koha/catalogue/detail.pl?biblionumber=[% m.id | uri %]">[% m.title | html %]</a>. Click on "Confirm your suggestion" to ignore this message.</span>
                            [% CASE %]
                                <span>[% m.code | html %]</span>
                            [% END %]
                        </div>
                        <!-- /.dialog -->
                    [% END # /FOR m %]

                    [% WRAPPER tabs id= "suggestiontabs" %]
                        [% WRAPPER tabs_nav %]
                            [% FOREACH suggestion IN suggestions %]
                                [% WRAPPER tab_item tabname= suggestion.suggestiontype %]
                                    [% IF ( suggestion.suggestiontypelabel ) %]
                                        [% IF (suggestion.suggestiontypelabel == "Pending") %]
                                            <span>Pending</span>
                                        [% ELSIF (suggestion.suggestiontypelabel == "Accepted") %]
                                            <span>Accepted</span>
                                        [% ELSIF (suggestion.suggestiontypelabel == "Checked") %]
                                            <span>Checked</span>
                                        [% ELSIF (suggestion.suggestiontypelabel == "Rejected") %]
                                            <span>Rejected</span>
                                        [% ELSIF (suggestion.suggestiontypelabel == "Available") %]
                                            <span>Available</span>
                                        [% ELSIF (suggestion.suggestiontypelabel == "Ordered") %]
                                            <span>Ordered</span>
                                        [% ELSIF (suggestion.suggestiontypelabel == "Unknown") %]
                                            <span>Status unknown</span>
                                        [% ELSIF (suggestion.suggestiontypelabel == "__ANY__") %]
                                            <span>Any</span>
                                        [% ELSE %]
                                            [% suggestion.suggestiontypelabel | html %]
                                        [% END %]
                                    [% ELSE %]
                                        [% IF ( suggestion.suggestiontype ) %]
                                            [% AuthorisedValues.GetByCode( 'SUGGEST_STATUS', suggestion.suggestiontype ) | html %]
                                        [% ELSE %]
                                            <span>No name</span>
                                        [% END %]
                                    [% END %]
                                    ([% suggestion.tab_count | html %])
                                [% END %]
                            [% END # /FOREACH suggestion %]
                        [% END # /WRAPPER tabs_nav %]

                        [% WRAPPER tab_panels %]
                            [% FOREACH suggestion IN suggestions %]
                                [% WRAPPER tab_panel tabname= suggestion.suggestiontype %]
                                    <form id="action_form" method="post" action="/cgi-bin/koha/suggestion/suggestion.pl">
                                        [% INCLUDE 'csrf-token.inc' %]
                                        <input type="hidden" name="op" value="cud-" />[%# filled by click event %]
                                        <input type="hidden" name="suggestionid" value="" />
                                    </form>
                                    <form class="update_suggestions" method="post" action="/cgi-bin/koha/suggestion/suggestion.pl#[% suggestion.suggestiontype| uri %]">
                                        [% INCLUDE 'csrf-token.inc' %]
                                        <input type="hidden" name="op" value="cud-" />[%# filled by submit %]

                                        [% IF suggestion.tab_count %]
                                            <p> <a class="checkall" href="#">Check all</a> | <a class="uncheckall" href="#">Uncheck all</a> </p>

                                            <table id="table_[% suggestion.suggestiontype | html %]" class="sorted" data-tab-name="[% suggestion.suggestiontype | html %]">
                                                <thead>
                                                    <tr>
                                                        <th class="no-sort no-export">&nbsp;</th>
                                                        <th class="anti-the">Suggestion</th>
                                                        <th>Suggested by</th>
                                                        <th>Suggester category</th>
                                                        <th>Suggested on</th>
                                                        <th>Patron reason</th>
                                                        <th>Managed by</th>
                                                        <th>Managed on</th>
                                                        <th>Last modification by</th>
                                                        <th>Last modification on</th>
                                                        <th>Last updated</th>
                                                        <th>Library</th>
                                                        <th>Fund</th>
                                                        <th>Non-public note</th>
                                                        <th>Status</th>
                                                        <th class="no-sort no-export">&nbsp;</th>
                                                    </tr>
                                                </thead>
                                            </table>
                                            <!-- /#table_[% suggestion.suggestiontype | html %] -->

                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <h2>Change selected suggestions</h2>
                                                </div>
                                            </div>
                                            <div class="suggestions_batch_ops row">
                                                [% IF CAN_user_suggestions_suggestions_manage %]
                                                    <div class="col-sm-4">
                                                        <fieldset class="brief">
                                                            <div id="select-reason-[% suggestion.suggestiontype | html %]">
                                                                <label for="STATUSreason-[% suggestion.suggestiontype | html %]">Mark selected as: </label>
                                                                <select name="STATUS" id="STATUSreason-[% suggestion.suggestiontype | html %]">
                                                                    <option value=""> -- Choose a status --</option>

                                                                    [% IF (statusselected_ASKED ) %]
                                                                        <option value="ASKED" selected="selected">Pending</option>
                                                                    [% ELSE %]
                                                                        <option value="ASKED">Pending</option>
                                                                    [% END %]

                                                                    [% IF (statusselected_ACCEPTED ) %]
                                                                        <option value="ACCEPTED" selected="selected">Accepted</option>
                                                                    [% ELSE %]
                                                                        <option value="ACCEPTED">Accepted</option>
                                                                    [% END %]

                                                                    [% IF (statusselected_CHECKED ) %]
                                                                        <option value="CHECKED" selected="selected">Checked</option>
                                                                    [% ELSE %]
                                                                        <option value="CHECKED">Checked</option>
                                                                    [% END %]

                                                                    [% IF ( statusselected_REJECTED ) %]
                                                                        <option value="REJECTED" selected="selected">Rejected</option>
                                                                    [% ELSE %]
                                                                        <option value="REJECTED">Rejected</option>
                                                                    [% END %]

                                                                    [% IF ( statusselected_ORDERED ) %]
                                                                        <option value="ORDERED" selected="selected">Ordered</option>
                                                                    [% ELSE %]
                                                                        <option value="ORDERED">Ordered</option>
                                                                    [% END %]

                                                                    [% IF ( statusselected_AVAILABLE ) %]
                                                                        <option value="AVAILABLE" selected="selected">Available</option>
                                                                    [% ELSE %]
                                                                        <option value="AVAILABLE">Available</option>
                                                                    [% END %]

                                                                    [% FOREACH s IN SuggestionStatuses %]
                                                                        <option value="[% s.authorised_value | html %]">[% s.lib | html %]</option>
                                                                    [% END %]
                                                                </select>

                                                                <label for="choosereason-[% suggestion.suggestiontype | html %]">with this reason:</label>
                                                                <select name="reason" id="choosereason-[% suggestion.suggestiontype | html %]">
                                                                    <option value=""> -- Choose a reason -- </option>
                                                                    [% FOREACH reasonsloo IN suggestion.reasonsloop %]
                                                                        <option value="[% reasonsloo.lib | html %]">[% reasonsloo.lib | html %]</option>
                                                                    [% END %]
                                                                    <option value="other">Others...</option>
                                                                </select>

                                                                <span class="other_reason">
                                                                    <input type="text" size="31" name="other_reason" placeholder="please note your reason here..." />
                                                                    <a href="#" class="cancel_note">Cancel</a>
                                                                </span>
                                                            </div>
                                                        </fieldset>
                                                        <fieldset class="action">
                                                            <input type="hidden" name="branchcode" value="[% branchfilter | html %]" />
                                                            <input type="hidden" name="filter_archived" value="[% filter_archived | html %]" />
                                                            <button type="submit" data-op="cud-update_status" class="btn btn-primary">Submit</button>
                                                        </fieldset>
                                                    </div>
                                                    <!-- /.col-sm-4 -->

                                                    <div class="col-sm-2">
                                                        <fieldset class="brief">
                                                            <label id="suggestion_itemtype"> Update item types with: </label>
                                                            [% PROCESS 'av-build-dropbox.inc' name="suggestion_itemtype", category="SUGGEST_FORMAT", size = 20 %]
                                                        </fieldset>
                                                        <fieldset class="action">
                                                            <input type="hidden" name="branchcode" value="[% branchfilter | html %]" />
                                                            <input type="hidden" name="filter_archived" value="[% filter_archived | html %]" />
                                                            <button type="submit" data-op="cud-update_itemtype" class="btn btn-primary">Submit</button>
                                                        </fieldset>
                                                    </div>
                                                    <!-- /.col-sm-4 -->

                                                    <div class="col-sm-2">
                                                        <fieldset class="brief">
                                                            <span class="label">Update manager</span>
                                                            <a
                                                                href="#patron_search_modal_manager_[% suggestion.suggestiontype | uri %]"
                                                                id="set_manager_[% suggestion.suggestiontype | uri %]"
                                                                data-tab="[% suggestion.suggestiontype | uri %]"
                                                                class="set_manager"
                                                                data-bs-toggle="modal"
                                                                ><i class="fa fa-search"></i> Select manager</a
                                                            >
                                                            <span id="managedby_name-[% suggestion.suggestiontype | html %]"></span>
                                                        </fieldset>
                                                        <fieldset class="action">
                                                            <input type="hidden" name="suggestion_managedby" id="managedby-[% suggestion.suggestiontype | html %]" value="[% logged_in_user.borrowernumber | html %]" />
                                                            <input type="hidden" name="branchcode" value="[% branchfilter | html %]" />
                                                            <input type="hidden" name="filter_archived" value="[% filter_archived | html %]" />
                                                            <button type="submit" data-op="cud-update_manager" class="btn btn-primary">Submit</button>
                                                        </fieldset>
                                                    </div>
                                                    <!-- /.col-sm-2 -->
                                                [% END %]

                                                [% IF CAN_user_suggestions_suggestions_delete %]
                                                    <div class="col-sm-2">
                                                        <fieldset class="brief">
                                                            <span class="label">Delete selected</span>
                                                        </fieldset>
                                                        <fieldset class="action">
                                                            <input type="hidden" name="branchcode" value="[% branchfilter | html %]" />
                                                            <input type="hidden" name="filter_archived" value="[% filter_archived | html %]" />
                                                            <button type="submit" data-op="cud-delete" class="btn btn-primary">Delete</button>
                                                        </fieldset>
                                                    </div>
                                                    <!-- /.col-sm-2 -->
                                                [% END %]

                                                [% IF CAN_user_suggestions_suggestions_manage %]
                                                    <div class="col-sm-2">
                                                        <fieldset class="brief">
                                                            <span class="label">Archive selected</span>
                                                            <fieldset class="action">
                                                                <input type="hidden" name="branchcode" value="[% branchfilter | html %]" />
                                                                <input type="hidden" name="filter_archived" value="[% filter_archived | html %]" />
                                                                <button type="submit" data-op="cud-archive" class="btn btn-primary">Archive</button>
                                                            </fieldset>
                                                        </fieldset>
                                                    </div>
                                                    <!-- /.col-sm-2 -->
                                                [% END %]
                                            </div>
                                            <!-- /.row -->
                                        [% ELSE %]
                                            <strong>No results.</strong>
                                        [% END # /IF ( suggestion.suggestions_loop ) %]
                                    </form>
                                    <!-- /.update_suggestions -->
                                [% END # /tab_panel# %]
                            [% END # /FOREACH suggestion %]
                        [% END # /WRAPPER tab_panels %]
                    [% END # /WRAPPER tabs %]
                [% END # /IF op == 'else' %]
            </div>
            <!-- /.col-md-8.offset-md-2 OR /.col-md-10.order-md-2 -->

            [% UNLESS op == 'save' %]
                [% UNLESS ( op == 'show' ) %]
                    <div class="col-md-2 order-sm-2 order-md-1">
                        <aside>
                            <form name="suggestionfilter" action="suggestion.pl" method="get">
                                <input type="hidden" name="branchcode" value="[% branchfilter | html %]" />
                                <fieldset class="brief">
                                    <h4>Organize by:</h4>
                                    <ol>
                                        <li>
                                            <label for="displayby" class="sr-only">Organize by: </label>
                                            <select name="displayby" id="displayby">
                                                [% IF ( displayby == "STATUS" ) %]
                                                    <option value="STATUS" selected="selected">Status</option>
                                                [% ELSE %]
                                                    <option value="STATUS">Status</option>
                                                [% END %]
                                                [% IF ( displayby == "branchcode" ) %]
                                                    <option value="branchcode" selected="selected">Library</option>
                                                [% ELSE %]
                                                    <option value="branchcode">Library</option>
                                                [% END %]
                                                [% IF ( displayby == "itemtype" ) %]
                                                    <option value="itemtype" selected="selected">Item type</option>
                                                [% ELSE %]
                                                    <option value="itemtype">Item type</option>
                                                [% END %]
                                                [% IF ( displayby == "managedby" ) %]
                                                    <option value="managedby" selected="selected">Managed by</option>
                                                [% ELSE %]
                                                    <option value="managedby">Managed by</option>
                                                [% END %]
                                                [% IF ( displayby == "acceptedby" ) %]
                                                    <option value="acceptedby" selected="selected">Accepted by</option>
                                                [% ELSE %]
                                                    <option value="acceptedby">Accepted by</option>
                                                [% END %]
                                            </select>
                                        </li>
                                    </ol>
                                </fieldset>
                                <!-- /.brief -->
                                <fieldset class="action">
                                    <input type="submit" class="btn btn-primary" value="Go" />
                                </fieldset>

                                <fieldset class="brief">
                                    <h4>Filter by: <a style="font-size:80%;font-weight:normal;" href="/cgi-bin/koha/suggestion/suggestion.pl">[clear]</a></h4>

                                    <div id="limits">
                                        <h4 class="local_collapse"><a href="#" data-bs-target=".biblio_information" data-bs-toggle="collapse">Bibliographic information</a></h4>
                                        <fieldset class="collapse biblio_information">
                                            <ol>
                                                <li>
                                                    <label for="title"> Title:</label>
                                                    <input type="text" id="title" name="title" value="[% title | html %]" />
                                                </li>
                                                <li>
                                                    <label for="author"> Author:</label>
                                                    <input type="text" id="author" name="author" value="[% author | html %]" />
                                                </li>
                                                <li>
                                                    <label for="isbn"> ISBN:</label>
                                                    <input type="text" id="isbn" name="isbn" value="[% isbn | html %]" />
                                                </li>
                                                <li>
                                                    <label for="publishercode"> Publisher:</label>
                                                    <input type="text" id="publishercode" name="publishercode" value="[% publishercode | html %]" />
                                                </li>
                                                <li>
                                                    <label for="copyrightdate_filter"> Copyright date:</label>
                                                    <input type="text" id="copyrightdate_filter" name="copyrightdate" value="[% copyrightdate | html %]" />
                                                </li>
                                                <li>
                                                    <label for="collectiontitle"> Collection title:</label>
                                                    <input type="text" id="collectiontitle" name="collectiontitle" value="[% collectiontitle | html %]" />
                                                </li>
                                            </ol>
                                        </fieldset>
                                        <!-- /.biblio_information -->
                                        <fieldset class="action biblio_information">
                                            <input type="submit" value="Go" />
                                        </fieldset>

                                        <h4 class="local_collapse"><a href="#" data-bs-target=".suggestion_information" data-bs-toggle="collapse">Suggestion information</a></h4>
                                        <fieldset class="collapse suggestion_information">
                                            <ol>
                                                <li>
                                                    <label for="STATUS-[% suggestion.suggestiontype | html %]"> Status:</label>
                                                    <select name="STATUS" id="STATUS-[% suggestion.suggestiontype | html %]">
                                                        <option value="">Any</option>
                                                        [% IF (statusselected_ASKED ) %]
                                                            <option value="ASKED" selected="selected">Pending</option>
                                                        [% ELSE %]
                                                            <option value="ASKED">Pending</option>
                                                        [% END %]

                                                        [% IF (statusselected_ACCEPTED ) %]
                                                            <option value="ACCEPTED" selected="selected">Accepted</option>
                                                        [% ELSE %]
                                                            <option value="ACCEPTED">Accepted</option>
                                                        [% END %]

                                                        [% IF (statusselected_CHECKED ) %]
                                                            <option value="CHECKED" selected="selected">Checked</option>
                                                        [% ELSE %]
                                                            <option value="CHECKED">Checked</option>
                                                        [% END %]

                                                        [% IF ( statusselected_REJECTED ) %]
                                                            <option value="REJECTED" selected="selected">Rejected</option>
                                                        [% ELSE %]
                                                            <option value="REJECTED">Rejected</option>
                                                        [% END %]

                                                        [% IF ( statusselected_ORDERED ) %]
                                                            <option value="ORDERED" selected="selected">Ordered</option>
                                                        [% ELSE %]
                                                            <option value="ORDERED">Ordered</option>
                                                        [% END %]

                                                        [% FOREACH s IN SuggestionStatuses %]
                                                            [% IF s.authorised_value == selected_status %]
                                                                <option value="[% s.authorised_value | html %]" selected="selected">[% s.lib | html %]</option>
                                                            [% ELSE %]
                                                                <option value="[% s.authorised_value | html %]">[% s.lib | html %]</option>
                                                            [% END %]
                                                        [% END %]
                                                    </select>
                                                </li>

                                                <li>
                                                    <label for="suggestedby"> Suggested by:</label>
                                                    <select id="suggestedby" name="suggestedby">
                                                        <option value="">Any</option>
                                                        [% FOREACH suggestedby_loo IN suggestedby_loop %]
                                                            [% IF ( suggestedby_loo.selected ) %]
                                                                <option value="[% suggestedby_loo.code | html %]" selected="selected">[% suggestedby_loo.desc | html %]</option>
                                                            [% ELSE %]
                                                                <option value="[% suggestedby_loo.code | html %]">[% suggestedby_loo.desc | html %]</option>
                                                            [% END %]
                                                        [% END %]
                                                    </select>
                                                </li>
                                                <li>
                                                    <label for="suggesteddate_from">Suggested date from:</label>
                                                    <input type="text" id="suggesteddate_from" size="10" name="suggesteddate_from" value="[% suggesteddate_from | html %]" data-date_to="suggesteddate_to" class="flatpickr" />
                                                </li>
                                                <li>
                                                    <label for="suggesteddate_to">To:</label>
                                                    <input type="text" id="suggesteddate_to" size="10" name="suggesteddate_to" value="[% suggesteddate_to | html %]" class="flatpickr" />
                                                </li>
                                                <li>
                                                    <label for="managedby"> Managed by:</label>
                                                    <select id="managedby" name="managedby">
                                                        <option value="">Any</option>
                                                        [% FOREACH managedby_loo IN managedby_loop %]
                                                            [% IF ( managedby_loo.selected ) %]
                                                                <option value="[% managedby_loo.code | html %]" selected="selected">[% managedby_loo.desc | html %]</option>
                                                            [% ELSE %]
                                                                <option value="[% managedby_loo.code | html %]">[% managedby_loo.desc | html %]</option>
                                                            [% END %]
                                                        [% END %]
                                                    </select>
                                                </li>
                                                <li>
                                                    <label for="manageddate_from">Management date from:</label>
                                                    <input type="text" id="manageddate_from" size="10" name="manageddate_from" value="[% manageddate_from | html %]" data-date_to="manageddate_to" class="flatpickr" />
                                                </li>
                                                <li>
                                                    <label for="manageddate_to">To:</label>
                                                    <input type="text" id="manageddate_to" size="10" name="manageddate_to" value="[% manageddate_to | html %]" class="flatpickr" />
                                                </li>
                                                <li>
                                                    <label for="acceptedby"> Accepted by:</label>
                                                    <select id="acceptedby" name="acceptedby">
                                                        <option value="">Any</option>
                                                        [% FOREACH acceptedby_loo IN acceptedby_loop %]
                                                            [% IF ( acceptedby_loo.selected ) %]
                                                                <option value="[% acceptedby_loo.code | html %]" selected="selected">[% acceptedby_loo.desc | html %]</option>
                                                            [% ELSE %]
                                                                <option value="[% acceptedby_loo.code | html %]">[% acceptedby_loo.desc | html %]</option>
                                                            [% END %]
                                                        [% END %]
                                                    </select>
                                                </li>
                                                <li>
                                                    <label for="accepteddate_from">Accepted date from:</label>
                                                    <input type="text" id="accepteddate_from" size="10" name="accepteddate_from" value="[% accepteddate_from | html %]" data-date_to="accepteddate_to" class="flatpickr" />
                                                </li>
                                                <li>
                                                    <label for="accepteddate_to">To:</label>
                                                    <input type="text" id="accepteddate_to" size="10" name="accepteddate_to" value="[% accepteddate_to | html %]" class="flatpickr" />
                                                </li>
                                            </ol>
                                        </fieldset>
                                        <!-- /#suggestion_information -->
                                        <fieldset class="action suggestion_information">
                                            <input type="submit" value="Go" />
                                        </fieldset>

                                        <h4 class="local_collapse">
                                            <a href="#" data-bs-target=".acquisition_information" data-bs-toggle="collapse">Acquisition information</a>
                                        </h4>
                                        <fieldset class="collapse acquisition_information">
                                            <ol>
                                                <li> [% PROCESS funds_dropdown %] </li>
                                            </ol>
                                        </fieldset>
                                        <!-- /#acquisition_information -->
                                        <fieldset class="action acquisition_information">
                                            <input type="submit" value="Go" />
                                        </fieldset>

                                        <div id="filter_archived_information">
                                            <ol>
                                                <li>
                                                    <label for="archived">
                                                        [% IF filter_archived %]
                                                            <input type="checkbox" id="archived" value="1" name="filter_archived" checked="checked" title="Include archived suggestions in the search" />
                                                        [% ELSE %]
                                                            <input type="checkbox" id="archived" value="1" name="filter_archived" title="Include archived suggestions in the search" />
                                                        [% END %]
                                                        Include archived
                                                    </label>
                                                </li>
                                            </ol>
                                        </div>
                                    </div>
                                    <!-- /#limits -->
                                </fieldset>
                                <!-- /.brief -->
                            </form>
                            <!-- /suggestionsfilter -->

                            [% INCLUDE 'acquisitions-menu.inc' %]
                        </aside>
                    </div>
                    <!-- /.col-md-2.order-md-1 -->
                [% END # /UNLESS ( op == 'show' ) %]
            [% END # /UNLESS op == 'save' %]
        </div>
        <!-- /.row -->
    </div>
    <!-- /.main.container-fluid -->
[% END # /IF op == "show" %]

[% BLOCK funds_dropdown %]
    <label for="budgetid">Fund:</label>
    <select name="budgetid" id="budgetid">
        [% UNLESS op == 'save' %]
            <option value="">Any</option>
        [% END %]
        [% IF budgetid == '__NONE__' %]
            <option value="__NONE__" selected="selected">None</option>
        [% ELSE %]
            <option value="__NONE__">None</option>
        [% END %]
        [% FOREACH budget IN sugg_budgets %]
            [% IF ( budget.selected ) %]
                <option value="[% budget.b_id | html %]" selected="selected">[% budget.b_txt | html %] [% IF ( !budget.b_active ) %](inactive)[% END %]</option>
            [% ELSIF ( budget.b_active ) %]
                <option value="[% budget.b_id | html %]">[% budget.b_txt | html %]</option>
            [% ELSE %]
                <option value="[% budget.b_id | html %]" class="b_inactive">[% budget.b_txt | html %] (inactive)</option>
            [% END %]
        [% END %]
    </select>
    <!-- this is needed -->
    <label for="showallfunds" style="float:none;width:auto;">&nbsp;Show inactive:</label>
    <input type="checkbox" class="showallfunds" />
[% END %]

[% MACRO jsinclude BLOCK %]
    [% INCLUDE 'calendar.inc' %]
    <script>
        function select_manager(borrowernumber, borrower) {
            let tab = $('#suggestiontabs .active table').data('tab-name');
            if ( tab ) {
                var managedby_name = $("#managedby_name-"+tab);
                var managedby = $("#managedby-"+tab);
            } else {
                var managedby_name = $("#managedby_name");
                var managedby = $("#managedby");
            }
            managedby_name.empty();
            managedby.val('');
            var borrowername = borrower.firstname + ' ' + borrower.surname;
            if (borrowernumber) {
                var managerlink = '<a href="/cgi-bin/koha/members/moremember.pl'
                    + '?borrowernumber=' + borrowernumber + '">'
                    + borrowername + '</a>';
                managedby_name.html(managerlink);
                managedby.val(borrowernumber);
            }

            [% IF op == "save" %]
                var notify = $('#notify');
                if ( notify.length ) {
                    [% IF managedby_patron %]
                        if ( borrowernumber == [% logged_in_user.borrowernumber | html %] || borrowernumber == [% managedby_patron.borrowernumber | html %] ) {
                    [% ELSE %]
                        if ( borrowernumber == [% logged_in_user.borrowernumber | html %] ) {
                    [% END %]
                        $(notify).prop('checked', false).prop('disabled', true);
                    } else {
                        $(notify).prop('disabled', false);
                    }
                }
            [% END %]
        }

        function select_suggester(borrowernumber, borrower) {
            $.ajax({
                type: 'GET',
                url: '/api/v1/patrons/' + borrowernumber,
                headers: {
                    "x-koha-embed": "+strings"
                },
                success: function (data) {
                    var suggested = '<input type="hidden" id="suggestedby" name="suggestedby" value="' + data.patron_id + '" />';
                    suggested += '<a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=' + data.patron_id + '">';
                    suggested += data.surname.escapeHtml() + ', ' + data.firstname.escapeHtml() + ' (' + data.cardnumber.escapeHtml() + ')';
                    suggested += '</a> ';
                    suggested += data._strings.library_id.str.escapeHtml() + ' (' + data._strings.category_id.str.escapeHtml() + ')';
                    $("#tdsuggestedby").html(suggested);

                },
                error: function (data) {
                    alert(_("Cannot retrieve info for this patron."));
                },
            });
            return 0;
        }

        //keep a copy of all budgets before removing the inactives
        var budgetId = $("#budgetid");
        var disabledBudgetsCopy = budgetId.html();
        $('.b_inactive').remove();

        $('.showallfunds').click(function() {
            if ($(this).is(":checked")) {
                budgetId.html(disabledBudgetsCopy); //Puts back all the funds
            }
            else {
                $('.b_inactive').remove();
            }
        });
    </script>
    [% IF ( op == 'show' || op == 'else' ) %]
        <script>
            $(document).ready(function () {
                $(".deletesuggestion").on("click", function () {
                    return confirm(_("Are you sure you want to delete this suggestion?"));
                });
            });
        </script>
    [% END %]
    [% IF op == 'else' %]
        [% INCLUDE 'datatables.inc' %]
        <script>
            $(document).ready(function() {
                [% IF suggestions.size %]
                    let suggestionData = [% To.json(suggestions) | $raw %];
                    var table_settings = [% TablesSettings.GetTableSettings( 'acqui', 'suggestions', 'suggestions', 'json' ) | $raw %]
                    function loadDatatable(tabName) {
                        let tabSuggestionData = suggestionData.find(s => s.suggestiontype === `${tabName}`)
                        $("#table_" + tabName).kohaTable(
                            {
                                sorting: [[4, "asc"]],
                                autoWidth: false,
                                ajax: {
                                    url: "/api/v1/suggestions?q=" + JSON.stringify(tabSuggestionData.search_params),
                                    delay: 300, // wait 300 milliseconds before triggering the request
                                    cache: true,
                                    dataType: "json",
                                },
                                serverSide: true,
                                embed: ["suggester", "suggester.category", "manager", "last_modifier", "library", "fund", "+strings"],
                                columns: [
                                    {
                                        data: "me.suggestion_id",
                                        searchable: false,
                                        orderable: false,
                                        render: function (data, type, row, meta) {
                                            return '<input type="checkbox" value="%s" name="suggestionid" />'.format(row.suggestion_id);
                                        }
                                    },
                                    {
                                        data: "me.title",
                                        searchable: true,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            let node = '<a href="suggestion.pl?suggestionid=%s&amp;op=show" title="%s">%s'.format(row.suggestion_id, _("suggestion"), row.title);
                                            if(row.author) node += ', by %s'.format(row.author);
                                            node += '</a><br />';
                                            if(row.copyright_date) node += ' &copy; <span class="suggestion_copyrightdate">%s</span>'.format(row.copyright_date);
                                            if(row.volume_desc) node += '; <span class="suggestion_volume">%s:<em>%s</em></span>'.format(_("Volume"), row.volume_desc);
                                            if(row.isbn) node += '; <span class="suggestion_isbn">%s:<em>%s</em></span>'.format(_("ISBN"), row.isbn);
                                            if(row.publisher_code) node += '; <span class="suggestion_publishercode">%s %s</span>'.format(_("Published by"), row.publisher_code);
                                            if(row.publication_year && row.publication_year != 0) node += '; <span class="suggestion_publicationyear"><em>%s</em></span>'.format(row.publication_year);
                                            if(row.publication_place) node += '; <span class="suggestion_place"><em>%s</em></span>'.format(row.publication_place);
                                            if(row.collection_title) node += '; <span class="suggestion_collectiontitle"><em>%s</em></span>'.format(row.collection_title);
                                            if(row.item_type && row._strings.item_type.str) node += '; <span class="suggestion_itype"><em>%s</em></span>'.format(row._strings.item_type.str);
                                            if(row.note) node += '<div class="suggestion_note">%s</div>'.format(row.note);
                                            if(row.archived) node += '<br /><i class="fa fa-archive"></i> %s'.format(_("Archived"));
                                            return node;
                                        }
                                    },
                                    {
                                        data: "suggester.surname:suggester.firstname:suggester.cardnumber",
                                        searchable: true,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            let suggester = row.suggester;
                                            if(suggester) {
                                                let node = '<a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=%s">%s'.format(suggester.patron_id, suggester.surname);
                                                if(suggester.firstname) node += ', %s'.format(suggester.firstname);
                                                if(suggester.cardnumber) node += ' (%s)'.format(suggester.cardnumber);
                                                node += '</a>';
                                                return node;
                                            }
                                            return ''
                                        }
                                    },
                                    {
                                        data: "suggester.category.name",
                                        searchable: false,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            return escape_str(row.suggester ? row.suggester.category.name : '');
                                        },
                                    },
                                    {
                                        data: "suggestion_date",
                                        searchable: false,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            return escape_str(row.suggestion_date ? $date(row.suggestion_date) : '');
                                        },
                                    },
                                    {
                                        data: "patron_reason",
                                        searchable: false,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            return escape_str(row._strings.patron_reason.str ? row._strings.patron_reason.str : '');
                                        },
                                    },
                                    {
                                        data: "manager.surname:manager.firstname",
                                        searchable: true,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            if(row.manager) {
                                                let node = '<a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=%s">%s'.format(row.manager?.patron_id, row.manager?.surname);
                                                if(row.manager?.firstname) node += ', %s'.format(row.manager?.firstname);
                                                node += '</a>';
                                                return node;
                                            }
                                            return ''
                                        },
                                    },
                                    {
                                        data: "managed_date",
                                        searchable: false,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            return escape_str(row.managed_date ? $date(row.managed_date) : '');
                                        },
                                    },
                                    {
                                        data: "last_modifier.surname:last_modifier.firstname",
                                        searchable: true,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            if(row.last_modifier) {
                                                let node = '<a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=%s">%s'.format(row.last_modifier?.patron_id, row.last_modifier?.surname);
                                                if(row.last_modifier?.firstname) node += ', %s'.format(row.last_modifier?.firstname);
                                                node += '</a>';
                                                return node;
                                            }
                                            return ''
                                        },
                                    },
                                    {
                                        data: "last_status_change_date",
                                        searchable: false,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            return escape_str(row.last_status_change_date ? $date(row.last_status_change_date) : '');
                                        },
                                    },
                                    {
                                        data: "last_status_change_date",
                                        searchable: false,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            return escape_str(row.last_status_change_date ? $date(row.last_status_change_date) : '');
                                        },
                                    },
                                    {
                                        data: "library.name",
                                        searchable: false,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            return escape_str(row.library?.name ? row.library.name : '');
                                        },
                                    },
                                    {
                                        data: "fund.name",
                                        searchable: false,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            return escape_str(row.fund?.name ? row.fund.name : '');
                                        },
                                    },
                                    {
                                        data: "staff_note",
                                        searchable: false,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            return escape_str(row.staff_note ? row.staff_note : '');
                                        },
                                    },
                                    {
                                        data: "status",
                                        searchable: false,
                                        orderable: true,
                                        render: function (data, type, row, meta) {
                                            let node = '';
                                            if(row.status === 'ASKED') node += '<span class="status asked">%s</span>'.format(_("Pending"));
                                            else if(row.status === 'ACCEPTED') node += '<span class="status accepted">%s</span>'.format(_("Accepted"));
                                            else if(row.status === 'ORDERED') node += '<span class="status ordered">%s</span>'.format(_("Ordered"));
                                            else if(row.status === 'REJECTED') node += '<span class="status rejected">%s</span>'.format(_("Rejected"));
                                            else if(row.status === 'CHECKED') node += '<span class="status checked">%s</span>'.format(_("Checked"));
                                            else if(row.status === 'AVAILABLE') node += '<span class="status available">%s</span>'.format(_("Available"));
                                            else if(row._strings.status.str) node += '<span class="status '+ row.status +'">%s</span>'.format(row._strings.status.str);
                                            else node += '<span class="status unknown">%s</span>'.format(_("Status unknown"));
                                            if ( row.reason ) {
                                                node += '<div class="reason" data-reason="'+row.reason+'">('+ row.reason +')</div>';
                                            }
                                            return node;
                                        },
                                    },
                                    {
                                        data: "suggestion_id",
                                        searchable: false,
                                        orderable: false,
                                        render: function (data, type, row, meta) {
                                            [% IF CAN_user_suggestions_suggestions_manage %]
                                                let node = '<div class="btn-group dropup">'
                                                node += '<a class="btn btn-default btn-xs" role="button" href="suggestion.pl?suggestionid=%s&amp;op=edit_form"><i class="fa-solid fa-pencil" aria-hidden="true"></i> %s</a>'.format(row.suggestion_id, _("Edit"))
                                                node += '<a class="btn btn-default btn-xs dropdown-toggle" id="more_actions_%s" role="button" data-bs-toggle="dropdown" href="#"><b class="caret"></b></a>'.format(row.suggestion_id)
                                                node += '<ul class="dropdown-menu" role="menu" aria-labelledby="more_actions_%s">'.format(row.suggestion_id)
                                                [% IF CAN_user_suggestions_suggestions_delete %]
                                                    node += '<li><a href="#" data-op="cud-delete" data-suggestionid="%s" class="dropdown-item trigger_action">%s</a></li>'.format(row.suggestion_id, _("Delete"))
                                                [% END %]
                                                [% UNLESS s.archived %]
                                                    node += '<li><a href="#" class="dropdown-item trigger_action" data-op="cud-archive" data-suggestionid="%s">%s</a></li>'.format(row.suggestion_id, _("Archive"))
                                                [% ELSE %]
                                                    node += '<li><a href="#" class="dropdown-item trigger_action" data-op="cud-unarchive" data-suggestionid="%s">%s</a></li>'.format(row.suggestion_id, _("Unarchive"))
                                                [% END %]
                                                node += '</ul></div>'
                                                return node
                                            [% ELSIF CAN_user_suggestions_suggestions_delete %]
                                                return '<button data-op="cud-delete" data-suggestionid="%s" class="btn btn-xs btn-default trigger_action"><i class="fa fa-trash-can"></i> %s</button>'.format(row.suggestion_id, _("Delete"))
                                            [% END %]
                                        },
                                        createdCell: function (cell, cellData, rowData, rowIndex, colIndex) {
                                            $(cell).find(".trigger_action").on("click", function(e) {
                                                var id = $(this).data('suggestionid');
                                                var op = $(this).data('op');
                                                if ( op == 'cud-delete' && !confirm(_("Are you sure you want to delete this suggestion?")) ) {
                                                    e.preventDefault();
                                                    return false;
                                                }
                                                $('#action_form input[name="op"]').val(op);
                                                $('#action_form input[name="suggestionid"]').val(id);
                                                $('#action_form').submit();
                                                return false;
                                            })
                                        }
                                    },
                                ]
                            },
                            table_settings
                        );
                    }
                    if( $("#suggestiontabs .tab-pane.active").length < 1 ){
                        $("#suggestiontabs a:first").tab("show");
                        loadDatatable($("#suggestiontabs a:first").data("tabname"))
                        $("#suggestiontabs a:first").attr("data-table_loaded", 'true')
                    }

                    [% FOREACH suggestion IN suggestions %]
                        $("#suggestiontabs #[% suggestion.suggestiontype | html %]-tab").on("click", function() {
                            if(!$(this).data("table_loaded")) {
                                loadDatatable("[% suggestion.suggestiontype | html%]")
                                $(this).attr("data-table_loaded", "true")
                            }
                        });
                    [% END %]
                [% END %]

                $("#branchcode").on('change',function(){
                [%# Modify the hidden input in the filters block from the library %]
                [%# dropdown list at the top of suggestion list %]
                    let branchcode = $(this).val();
                    $('input[name="branchcode"]').val( branchcode );
                    $('form[name="suggestionfilter"]').submit();
                });

                $(".checkall").click(function(e){
                    e.preventDefault();
                    $(this).parents('form').find("input:checkbox").each(function(){
                        $(this).prop("checked", true);
                    });
                });
                $(".uncheckall").click(function(e){
                    e.preventDefault();
                    $(this).parents('form').find("input:checkbox").each(function(){
                        $(this).prop("checked", false);
                    });
                });
                $(".other_reason").hide();
                $("select[name='reason']").change(function(){
                    if($(this).val() == "other"){
                        $(this).hide();
                        $(this).siblings(".other_reason").show();
                    }
                });

                $("a.cancel_note").click(function(e) {
                    $(this).parent().siblings("select").show().find("option[value='']").attr("selected","selected");
                    $(this).siblings("input[name='other_reason']").hide();
                    e.preventDefault();
                });

                $("h4.local_collapse a").on("click", function(e){
                    e.preventDefault();
                    const target = $(this).data("target");
                    $("." + target).toggle();
                });

                $("form.update_suggestions button[type='submit']").on("click", function(e) {
                    var submit_button = this;
                    var op = $(submit_button).data('op');
                    var selected_suggestions = $('form.update_suggestions').find("input[type='checkbox'][name='suggestionid']:checked");

                    if ( selected_suggestions.length == 0 ) {
                        alert(_("Please select at least one suggestion"));
                        e.preventDefault();
                        return false;
                    }

                    if ( op === "cud-delete" ) {
                        if ( ! confirm(_("Are you sure you want to delete these suggestions?")) ) {
                            e.preventDefault();
                            return false;
                        }
                    } else if ( op === "cud-update_manager" ) {
                        var managedby = $(submit_button).siblings("suggestion_managedby");
                        if ( managedby.val() == "" ) {
                            alert(_("Please select a manager to assign to the selected suggestions"));
                            e.preventDefault();
                            return false;
                        }
                    }
                    $("form.update_suggestions input[name='op']").val(op);
                    return true;
                });
            });
        </script>
    [% END %]
    [% IF op == 'save' %]
        <script>
            $(document).ready(function(){
                calcNewsuggTotal();
                $("#quantity,#price,#currency").on("change",function(){
                    calcNewsuggTotal();
                });

                [% IF other_reason %]
                    $(".select-reason").hide();
                    $(".select-reason").find("option[value='other']").attr("selected","selected");
                    $("#other_reason").show();
                [% ELSE %]
                    $("#other_reason").hide();
                [% END %]
                $(".select-reason").change(function(){
                    if($(this).val() == "other"){
                        $(this).hide();
                        $("#other_reason").show();
                    }
                });
                $("a[href*=back]").click(function(){
                    $(".select-reason").show().find("option[value='']").attr("selected","selected");
                    $("#other_reason").hide();
                });

                $("#restore_previous_manager").on("click",function(e){
                    e.preventDefault();

                    $("#managedby_name").empty();
                    $("#managedby").val('');
                    var borrowername = "[% managedby_patron.firstname | html %] [% managedby_patron.surname | html %]";
                    var managerlink = '<a href="/cgi-bin/koha/members/moremember.pl'
                        + '?borrowernumber=[% managedby_patron.borrowernumber | html %]">'
                        + borrowername + '</a>';
                    $('#managedby_name').html(managerlink);
                    $('#managedby').val([% managedby_patron.borrowernumber | html %]);
                    $('#notify').prop('checked', false).prop('disabled', true);
                });


            });
        </script>
    [% END %]
    [% Asset.js("js/acq.js") | $raw %]
    [% Asset.js("js/acquisitions-menu.js") | $raw %]

    [% INCLUDE 'select2.inc' %]
    [% SET columns = ['cardnumber','name','category','branch','action'] %]
    [% IF op == 'save' %]
        [% PROCESS patron_search_modal columns => columns, modal_title => t("Select suggester"), patron_search_modal_id => 'patron_search_modal_suggester', table_id => 'patron_search_modal_suggester_table' %]
        [% PROCESS patron_search_js columns => columns, actions => ["select"], preview_on_name_click => 1, table_id => 'patron_search_modal_suggester_table', callback => 'select_suggester' %]
        [% SET filter = "suggestions_managers" %]
        [% PROCESS patron_search_modal columns => columns, modal_title => t("Select manager"), patron_search_modal_id => 'patron_search_modal_manager', table_id => 'patron_search_modal_manager_table' %]
        [% PROCESS patron_search_js columns => columns, actions => ["select"], preview_on_name_click => 1, table_id => 'patron_search_modal_manager_table', callback => 'select_manager' %]
    [% ELSIF op == 'else' %]
        [% FOREACH suggestion IN suggestions %]
            [% SET filter = "suggestions_managers" %]
            [% PROCESS patron_search_modal columns => columns, modal_title => t("Select manager"), patron_search_modal_id => 'patron_search_modal_manager_' _ suggestion.suggestiontype, table_id => 'patron_search_modal_manager_table_' _ suggestion.suggestiontype %]
            [% PROCESS patron_search_js columns => columns, actions => ["select"], preview_on_name_click => 1, table_id => 'patron_search_modal_manager_table_' _ suggestion.suggestiontype, callback => 'select_manager' %]
        [% END %]
    [% END %]
[% END %]
[% INCLUDE 'intranet-bottom.inc' %]
